// auto generated by kmigrator
// KMIGRATOR:0230_incidentchange_changedbyname_and_more:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMSBvbiAyMDIzLTAzLTA5IDA3OjIwCgpmcm9tIGRqYW5nby5kYiBpbXBvcnQgbWlncmF0aW9ucywgbW9kZWxzCgoKY2xhc3MgTWlncmF0aW9uKG1pZ3JhdGlvbnMuTWlncmF0aW9uKToKCiAgICBkZXBlbmRlbmNpZXMgPSBbCiAgICAgICAgKCdfZGphbmdvX3NjaGVtYScsICcwMjI5X2JhbmtzeW5jdGFza2hpc3RvcnlyZWNvcmRfYmFua3N5bmN0YXNrJyksCiAgICBdCgogICAgb3BlcmF0aW9ucyA9IFsKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSdpbmNpZGVudGNoYW5nZScsCiAgICAgICAgICAgIG5hbWU9J2NoYW5nZWRCeU5hbWUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuVGV4dEZpZWxkKGJsYW5rPVRydWUsIG51bGw9VHJ1ZSksCiAgICAgICAgKSwKICAgICAgICBtaWdyYXRpb25zLkFkZEZpZWxkKAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRjaGFuZ2UnLAogICAgICAgICAgICBuYW1lPSdjaGFuZ2VkQnlOYW1lJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLlRleHRGaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Set Statement Timeout to some large amount - 25 min (25 * 60 => 1500 sec)
--
    SET statement_timeout = '1500s';
--
--
-- Add field changedByName to incidentchange
--
ALTER TABLE "IncidentChange" ADD COLUMN "changedByName" text NULL;
--
-- Add field changedByName to ticketchange
--
ALTER TABLE "TicketChange" ADD COLUMN "changedByName" text NULL;

-- [CUSTOM] Update changedByName field
UPDATE "TicketChange"
SET "changedByName" = "User".name
FROM "User"
WHERE "User".id = "TicketChange"."createdBy";

UPDATE "IncidentChange"
SET "changedByName" = "User".name
FROM "User"
WHERE "User".id = "IncidentChange"."createdBy";

--
-- [CUSTOM] Revert Statement Timeout to default amount - 10 secs
--
    SET statement_timeout = '10s';

COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Add field changedByName to ticketchange
--
ALTER TABLE "TicketChange" DROP COLUMN "changedByName" CASCADE;
--
-- Add field changedByName to incidentchange
--
ALTER TABLE "IncidentChange" DROP COLUMN "changedByName" CASCADE;
COMMIT;

    `)
}
