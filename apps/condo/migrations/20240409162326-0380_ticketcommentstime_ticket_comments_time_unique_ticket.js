// auto generated by kmigrator
// KMIGRATOR:0380_ticketcommentstime_ticket_comments_time_unique_ticket:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDQuMC41IG9uIDIwMjQtMDQtMDkgMTE6MjMKCmZyb20gZGphbmdvLmRiIGltcG9ydCBtaWdyYXRpb25zLCBtb2RlbHMKCgpjbGFzcyBNaWdyYXRpb24obWlncmF0aW9ucy5NaWdyYXRpb24pOgoKICAgIGRlcGVuZGVuY2llcyA9IFsKICAgICAgICAoJ19kamFuZ29fc2NoZW1hJywgJzAzNzlfdXNlcmhlbHByZXF1ZXN0X3VzZXJoZWxwcmVxdWVzdGZpbGVfdXNlcmhlbHByZXF1ZXN0ZmlsZWhpc3RvcnlyZWNvcmRfdXNlcmhlbHByZXF1ZXN0aGlzdG9yeXJlY29yZCcpLAogICAgXQoKICAgIG9wZXJhdGlvbnMgPSBbCiAgICAgICAgbWlncmF0aW9ucy5BZGRDb25zdHJhaW50KAogICAgICAgICAgICBtb2RlbF9uYW1lPSd0aWNrZXRjb21tZW50c3RpbWUnLAogICAgICAgICAgICBjb25zdHJhaW50PW1vZGVscy5VbmlxdWVDb25zdHJhaW50KGNvbmRpdGlvbj1tb2RlbHMuUSgoJ2RlbGV0ZWRBdF9faXNudWxsJywgVHJ1ZSkpLCBmaWVsZHM9KCd0aWNrZXQnLCksIG5hbWU9J3RpY2tldF9jb21tZW50c190aW1lX3VuaXF1ZV90aWNrZXQnKSwKICAgICAgICApLAogICAgXQo=

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- [CUSTOM] Deletes TicketCommentsTime duplicates
--
DO
$$
DECLARE
    duplicateData        RECORD;
    lastUpdatedItemId    uuid;
BEGIN
    FOR duplicateData IN
        SELECT "ticket"
        FROM "TicketCommentsTime"
        WHERE "deletedAt" IS NULL
        GROUP BY "ticket"
        HAVING count(*) > 1
    LOOP
        -- Finding the newest entry
        lastUpdatedItemId := (
            SELECT "id"
            FROM "TicketCommentsTime"
            WHERE "deletedAt" IS NULL
                AND "ticket" = duplicateData.ticket
            ORDER BY "lastCommentAt" DESC
            LIMIT 1
        );

        -- Deleting duplicates
        UPDATE "TicketCommentsTime"
        SET "deletedAt" = now()
        WHERE "deletedAt" IS NULL
            AND "ticket" = duplicateData.ticket
            AND "id" != lastUpdatedItemId;

    END LOOP;
END
$$;

--
-- Create constraint ticket_comments_time_unique_ticket on model ticketcommentstime
--
CREATE UNIQUE INDEX "ticket_comments_time_unique_ticket" ON "TicketCommentsTime" ("ticket") WHERE "deletedAt" IS NULL;
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Create constraint ticket_comments_time_unique_ticket on model ticketcommentstime
--
DROP INDEX IF EXISTS "ticket_comments_time_unique_ticket";
COMMIT;

    `)
}
