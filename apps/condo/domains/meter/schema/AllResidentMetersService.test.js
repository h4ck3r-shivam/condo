/**
 * Generated by `createservice meter.AllResidentMetersService`
 */
const { faker } = require('@faker-js/faker')


const { makeLoggedInAdminClient, makeClient } = require('@open-condo/keystone/test.utils')
const {
    expectToThrowAccessDeniedErrorToResult,
    expectToThrowAuthenticationErrorToResult,
} = require('@open-condo/keystone/test.utils')

const {
    makeContextWithOrganizationAndIntegrationAsAdmin,
    createTestBillingProperty,
    createTestBillingAccount,
} = require('@condo/domains/billing/utils/testSchema')
const {
    allResidentMetersByTestClient,
    MeterResource,
    createTestMeter,
} = require('@condo/domains/meter/utils/testSchema')
const { createTestOrganization } = require('@condo/domains/organization/utils/testSchema')
const { FLAT_UNIT_TYPE } = require('@condo/domains/property/constants/common')
const { createTestProperty } = require('@condo/domains/property/utils/testSchema')
const { createTestResident } = require('@condo/domains/resident/utils/testSchema')
const { createTestServiceConsumer } = require('@condo/domains/resident/utils/testSchema')
const {
    makeClientWithSupportUser,
    makeClientWithResidentUser,
    makeClientWithStaffUser,
} = require('@condo/domains/user/utils/testSchema')

const { COLD_WATER_METER_RESOURCE_ID } = require('../constants/constants')


describe('AllResidentMetersService', () => {
    let admin
    let residentClient

    beforeAll(async () => {
        admin = await makeLoggedInAdminClient()
        residentClient = await makeClientWithResidentUser()
    })

    describe('Resident', () => {
        it('should get all meters from resident organization', async () => {
            const { organization, context } = await makeContextWithOrganizationAndIntegrationAsAdmin()
            const [property] = await createTestProperty(admin, organization)
            const [billingProperty] = await createTestBillingProperty(admin, context)
            const [billingAccount] = await createTestBillingAccount(admin, context, billingProperty)

            const unitName = faker.random.alphaNumeric(8)
            const unitType = FLAT_UNIT_TYPE

            const [resident] = await createTestResident(admin, residentClient.user, property, { unitName, unitType })
            await createTestServiceConsumer(admin, resident, organization, { accountNumber: billingAccount.number })
            const [resource] = await MeterResource.getAll(residentClient, { id: COLD_WATER_METER_RESOURCE_ID })
            const [meter] = await createTestMeter(admin, organization, property, resource, {
                accountNumber: billingAccount.number, unitName, unitType,
            })

            const [data] = await allResidentMetersByTestClient(residentClient, {
                resident: resident.id,
            })

            expect(data).toHaveProperty('meters')
            expect(data.meters).toHaveLength(1)
            expect(data.meters).toEqual(
                expect.arrayContaining([
                    expect.objectContaining(meter),
                ]),
            )
        })

        it('can\'t get meters by another resident', async () => {
            const client = await makeClientWithResidentUser()

            const [organization] = await createTestOrganization(admin)
            const [property] = await createTestProperty(admin, organization)

            const unitName = faker.random.alphaNumeric(8)

            const [resident] = await createTestResident(admin, client.user, property, { unitName, unitType: FLAT_UNIT_TYPE })

            await expectToThrowAccessDeniedErrorToResult(async () => {
                await allResidentMetersByTestClient(residentClient, { resident: resident.id })
            })
        })
    })

    test('user: execute', async () => {
        const client = await makeClient()  // TODO(codegen): use truly useful client!
        const payload = {}  // TODO(codegen): change the 'user: update AllResidentMetersService' payload
        const [data, attrs] = await allResidentMetersByTestClient(client, payload)
        // TODO(codegen): write user expect logic
        throw new Error('Not implemented yet')
    })

    test('anonymous: execute', async () => {
        const client = await makeClient()
        await expectToThrowAuthenticationErrorToResult(async () => {
            await allResidentMetersByTestClient(client)
        })
    })

    test('admin: execute', async () => {
        const admin = await makeLoggedInAdminClient()
        const payload = {}  // TODO(codegen): change the 'user: update AllResidentMetersService' payload
        const [data, attrs] = await allResidentMetersByTestClient(admin, payload)
        // TODO(codegen): write admin expect logic
        throw new Error('Not implemented yet')
    })
})
